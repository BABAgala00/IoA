Hunting Lateral Movement with Microsoft ATP KQL
References, the DFIR report, Lateral Movement section:
https://thedfirreport.com/2025/08/05/from-bing-search-to-ransomware-bumblebee-and-adaptixc2-deliver-akira/

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

// Hunt for RMM and SBM network connections using newly created local accounts
// https://thedfirreport.com/2025/08/05/from-bing-search-to-ransomware-bumblebee-and-adaptixc2-deliver-akira/

let NewAccounts = (DeviceEvents // Local accounts created in the last 10 days
| where ActionType == "UserAccountCreated"
| where Timestamp between (ago(10d) .. now())
| distinct AccountName,AccountSid,DeviceName);
NewAccounts // Establishing SSH\RDP\VNC\SBM remote connection
| join DeviceNetworkEvents on $left.AccountName == $right.InitiatingProcessAccountName,DeviceName
| where RemotePort == 22 or RemotePort == 3389 or RemotePort == 5900 or LocalPort == 22 or LocalPort == 3389 or LocalPort == 5900 or RemotePort == 445 or LocalPort == 445 // Decide if to adjust more RMM ports
| where not(isempty(InitiatingProcessAccountUpn) or isempty(InitiatingProcessAccountName) or isempty(InitiatingProcessAccountSid))
| project-reorder Timestamp,DeviceName,InitiatingProcessAccountUpn,InitiatingProcessAccountName,InitiatingProcessAccountSid,RemoteIP,RemotePort,RemoteUrl


// This query detects new local accounts created in the past 10 days, which are connected to the DC or other labeled sensitive servers.
// https://thedfirreport.com/2025/08/05/from-bing-search-to-ransomware-bumblebee-and-adaptixc2-deliver-akira/

// Adjustments needed below
let SesitiveServers = (DeviceInfo
| where MachineGroup has "DCTag" // Filter by relevant device tag. If no device tag, by naming convention, "RegistryDeviceTag" column, or other filter that labels your sensitive servers such as DCs, etc.
| distinct DeviceName);
let NewLLocalAccounts = (DeviceEvents
| where ActionType == "UserAccountCreated"
| where Timestamp > ago(10d) // New local accounts creation, you can adjust the time frame.
| distinct AccountName,AccountSid,LocalAccountDeviceName=DeviceName,AccountTimeCreated=Timestamp);
DeviceLogonEvents // Detects logon events to labled servers by new local accounts.
| where DeviceName in~ (SesitiveServers)
| join NewLLocalAccounts on $left.AccountName == $right.AccountName
| project-rename NewLocalAccountName=AccountName
| project-reorder Timestamp,AccountTimeCreated,DeviceName,LocalAccountDeviceName,NewLocalAccountName,ActionType,LogonType
