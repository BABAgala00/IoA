## Hunting Lateral Movement with Microsoft ATP KQL

### References, the DFIR report, Lateral Movement section:<br>
https://thedfirreport.com/2025/08/05/from-bing-search-to-ransomware-bumblebee-and-adaptixc2-deliver-akira/

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

// Hunt for RMM and SBM network connections using newly created local accounts<br>


let NewAccounts = (DeviceEvents // Local accounts created in the last 10 days<br>
| where ActionType == "UserAccountCreated"<br>
| where Timestamp between (ago(10d) .. now())<br>
| distinct AccountName,AccountSid,DeviceName);<br>
NewAccounts // Establishing SSH\RDP\VNC\SBM remote connection<br>
| join DeviceNetworkEvents on $left.AccountName == $right.InitiatingProcessAccountName,DeviceName<br>
| where RemotePort == 22 or RemotePort == 3389 or RemotePort == 5900 or LocalPort == 22 or LocalPort == 3389 or LocalPort == 5900 or RemotePort == 445 or LocalPort == 445 // Decide if to adjust more RMM ports<br>
| where not(isempty(InitiatingProcessAccountUpn) or isempty(InitiatingProcessAccountName) or isempty(InitiatingProcessAccountSid))<br>
| project-reorder Timestamp,DeviceName,InitiatingProcessAccountUpn,InitiatingProcessAccountName,InitiatingProcessAccountSid,RemoteIP,RemotePort,RemoteUrl<be>

<br>
// This query detects new local accounts created in the past 10 days, which are connected to the DC or other labeled sensitive servers.<br>
<br>

let SesitiveServers = (DeviceInfo<br>
| where MachineGroup has "DCTag" // !! Modify the device tag filter as set in your environment. If no device tag, by naming convention, "RegistryDeviceTag" column, or other filter that labels your sensitive servers such as DCs, etc.<br>
| distinct DeviceName);<br>
let NewLLocalAccounts = (DeviceEvents<br>
| where ActionType == "UserAccountCreated"<br>
| where Timestamp > ago(10d) // New local accounts creation, you can adjust the time frame.<br>
| distinct AccountName,AccountSid,LocalAccountDeviceName=DeviceName,AccountTimeCreated=Timestamp);<br>
DeviceLogonEvents // Detects logon events to labled servers by new local accounts.<br>
| where DeviceName in~ (SesitiveServers)<br>
| join NewLLocalAccounts on $left.AccountName == $right.AccountName<br>
| project-rename NewLocalAccountName=AccountName<br>
| project-reorder Timestamp,AccountTimeCreated,DeviceName,LocalAccountDeviceName,NewLocalAccountName,ActionType,LogonType<br>
